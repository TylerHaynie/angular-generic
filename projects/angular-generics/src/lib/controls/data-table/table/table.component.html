<div class="component-wrapper">

  <div [ngClass]="{'no-header': !showHeader}" class="table-header">
    <div *ngIf="showHeader" class="title">
      {{ title }}
      <div class="loader">
        <mat-spinner *ngIf="loading" [diameter]="20"></mat-spinner>
      </div>
    </div>
    <div *ngIf="showHeader" class="header-controls">
      <div class="group-by" *ngIf="allowGroup">
        <div *ngIf="grouped" class="drop-down">
          <ag-select [options]="activeColumns" [(ngModel)]="dataTable.groupBy"
                     [displayName]="'display'" [placeholder]="'select...'" [disabled]="!(dataTable || dataSource.data)"
                     [labelPosition]="'above'" (selectionChange)="groupChanged($event)">Group By</ag-select>
        </div>
      </div>
      <div class="export-container" *ngIf="allowExport">
        <button *ngIf="allowExport" mat-raised-button color="accent"
                (click)="doExport()" [disabled]="!(dataTable || dataSource.data)">
          Export
        </button>
      </div>
    </div>
  </div>

  <div class="table-wrapper">

    <!-- Ungrouped -->
    <ng-container *ngIf="!grouped">
      <ng-container *ngTemplateOutlet="tableTemplate;context:{$implicit: dataSource.data}"></ng-container>
    </ng-container>

    <!-- Grouped -->
    <ng-container *ngIf="grouped">
      <mat-accordion>
        <ng-container *ngFor="let tableData of dataSource.data | async | keyvalue">

          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{dataTable.groupBy.name}} : &nbsp; <b>{{tableData.key}}</b>
              </mat-panel-title>
              <mat-panel-description>
                Records: &nbsp; {{tableData.page.recordCount}}
              </mat-panel-description>
            </mat-expansion-panel-header>

            <ng-container *ngTemplateOutlet="tableTemplate;context:{$implicit: tableData.value, key: tableData.key}">
            </ng-container>
          </mat-expansion-panel>

        </ng-container>
      </mat-accordion>
    </ng-container>

  </div>
</div>

<ng-template #tableTemplate let-tdata let-tkey="key">
  <table mat-table [dataSource]="tdata">
    <ng-container *ngFor="let column of columns" [matColumnDef]="column.name">
      <th mat-header-cell *matHeaderCellDef>
        {{ column.display ? column.display : column.name }}
      </th>
      <td mat-cell *matCellDef="let element">
        {{ column.cellValue ? column.cellValue(element) : "" }}
      </td>
      <ng-container *ngIf="showFooter">
        <td mat-footer-cell *matFooterCellDef="let element">
          {{ column.calculate ? calculateTotal(column, tkey)  : ""  }}
        </td>
      </ng-container>
    </ng-container>

    <ng-container matColumnDef="pager">
      <td mat-footer-cell *matFooterCellDef [attr.colspan]="activeColumns.length">
        <app-table-pager [(page)]="dataTable.page" (pageChange)="pageChanged($event)"></app-table-pager>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="activeColumns; sticky: true"></tr>
    <tr mat-row *matRowDef="let row; columns: activeColumns;"></tr>
    <ng-container *ngIf="showFooter">
      <tr class="total-footer" mat-footer-row *matFooterRowDef="activeColumns; sticky: true"></tr>
    </ng-container>
    <ng-container *ngIf="showPager">
      <tr mat-footer-row *matFooterRowDef="['pager']; sticky: true"></tr>
    </ng-container>

  </table>
</ng-template>